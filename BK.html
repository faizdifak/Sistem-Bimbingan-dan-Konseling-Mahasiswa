<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sistem Bimbingan dan Konseling Mahasiswa - (Persist LocalStorage)</title>

  <!-- Bootstrap & FontAwesome -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

  <style>
    :root {
      --primary: #2c3e50;
      --secondary: #3498db;
      --accent: #e74c3c;
    }
    body { background:#f8f9fa; font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; }
    .navbar { background: var(--primary); }
    .sidebar { background: var(--primary); color:#fff; height:100vh; position:fixed; padding-top:60px; }
    .sidebar a { color:#fff; padding:12px 18px; display:block; text-decoration:none; }
    .sidebar a:hover, .sidebar a.active { background: var(--secondary); color:#fff; }
    .main-content { margin-left:250px; padding:20px; padding-top:80px; }
    .card { border-radius:10px; box-shadow:0 4px 8px rgba(0,0,0,0.08); border:none; }
    .card-header { background:var(--primary); color:#fff; border-radius:10px 10px 0 0; }
    .btn-primary { background:var(--secondary); border:none; }
    .login-container { height:100vh; display:flex; align-items:center; justify-content:center; background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); }
    .login-card { width:420px; border-radius:12px; box-shadow:0 10px 25px rgba(0,0,0,0.2); }
    .content-section { display:none; }
    .content-section.active { display:block; }
    .table th { background: var(--primary); color:#fff; }
    .bg-primary-soft { background:#eef6fb; }
    .small-muted { color:#6c757d; }
  </style>
</head>
<body>
  <!-- REGISTER PAGE -->
  <div id="register-page" class="login-container" style="display:none;">
    <div class="card login-card">
      <div class="card-header text-center">
        <h4 class="mb-0"><i class="fas fa-user-plus me-2"></i>Daftar Akun</h4>
        <p class="mb-0 small-muted">Silakan daftar untuk mengakses sistem</p>
      </div>
      <div class="card-body">
        <form id="register-form">
          <div class="mb-3"><label class="form-label">Username</label><input id="reg-username" class="form-control" required></div>
          <div class="mb-3"><label class="form-label">Email</label><input id="reg-email" type="email" class="form-control" required></div>
          <div class="mb-3"><label class="form-label">Password</label><input id="reg-password" type="password" class="form-control" required></div>
          <div class="mb-3"><label class="form-label">Daftar Sebagai</label>
            <select id="reg-role" class="form-select"><option value="mahasiswa">Mahasiswa</option><option value="dosen">Dosen</option></select>
          </div>
          <button class="btn btn-primary w-100" type="submit">Daftar</button>
        </form>
        <p class="text-center mt-3">Sudah punya akun? <a href="#" id="to-login-from-reg">Login</a></p>
      </div>
    </div>
  </div>

  <!-- LOGIN PAGE -->
  <div id="login-page" class="login-container">
    <div class="card login-card">
      <div class="card-header text-center">
        <h4 class="mb-0"><i class="fas fa-graduation-cap me-2"></i>Sistem Bimbingan dan Konseling</h4>
        <p class="mb-0 small-muted">PRODI KEPERAWATAN MAGELANG</p>
      </div>
      <div class="card-body">
        <form id="login-form">
          <div class="mb-3"><label class="form-label">Username / Email</label><input id="username" class="form-control" required></div>
          <div class="mb-3"><label class="form-label">Password</label><input id="password" type="password" class="form-control" required></div>
          <button class="btn btn-primary w-100" type="submit">Login</button>
        </form>
        <p class="text-center mt-3">Belum punya akun? <a href="#" id="to-register">Daftar sekarang</a></p>
      </div>
    </div>
  </div>

  <!-- MAIN APP -->
  <div id="main-app" style="display:none;">
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
      <div class="container-fluid">
        <a class="navbar-brand" href="#"><i class="fas fa-graduation-cap me-2"></i>Bimbingan Konseling</a>
        <div class="d-flex align-items-center ms-auto">
          <div class="me-3 text-white" id="user-name">Nama Pengguna</div>
          <div class="dropdown">
            <a class="text-white dropdown-toggle" href="#" role="button" id="userMenu" data-bs-toggle="dropdown" aria-expanded="false"><i class="fas fa-user"></i></a>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userMenu">
              <li><a class="dropdown-item" href="#" data-target="profil" id="menu-profil">Profile</a></li>
              <li><a class="dropdown-item" href="#" data-target="pengaturan" id="menu-settings">Settings</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item" href="#" id="logout-btn">Logout</a></li>
            </ul>
          </div>
        </div>
      </div>
    </nav>

    <!-- Sidebar -->
    <div class="sidebar" style="width:250px;">
      <a href="#" class="active" data-target="dashboard"><i class="fas fa-home me-2"></i> Dashboard</a>
      <a href="#" data-target="booking"><i class="fas fa-calendar-alt me-2"></i> Booking Bimbingan</a>
      <a href="#" data-target="laporan"><i class="fas fa-file-alt me-2"></i> Laporan Bimbingan</a>
      <a href="#" data-target="mahasiswa-section"><i class="fas fa-user-graduate me-2"></i> Data Mahasiswa</a>
      <a href="#" data-target="dosen-section"><i class="fas fa-chalkboard-teacher me-2"></i> Data Dosen</a>
      <a href="#" data-target="riwayat"><i class="fas fa-history me-2"></i> Riwayat Bimbingan</a>
      <a href="#" data-target="pengaturan"><i class="fas fa-cog me-2"></i> Pengaturan</a>
    </div>

    <!-- Main content -->
    <div class="main-content">
      <div class="container-fluid">
        <!-- Dashboard -->
        <div id="dashboard" class="content-section active">
          <div class="row">
            <div class="col-md-8">
              <div class="card">
                <div class="card-header">
                  <h5 class="mb-0">Selamat Datang di Sistem Bimbingan dan Konseling</h5>
                </div>
                <div class="card-body">
                  <p>Sistem ini digunakan untuk memfasilitasi proses bimbingan akademik antara mahasiswa dan dosen pembimbing.</p>
                  <div class="row mt-4">
                    <div class="col-md-6">
                      <div class="card bg-primary text-white text-center p-3">
                        <h3><i class="fas fa-users"></i></h3>
                        <h5>Mahasiswa</h5>
                        <h2 id="count-mahasiswa">0</h2>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="card bg-success text-white text-center p-3">
                        <h3><i class="fas fa-chalkboard-teacher"></i></h3>
                        <h5>Dosen</h5>
                        <h2 id="count-dosen">0</h2>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Jadwal (right column) -->
            <div class="col-md-4">
              <div class="card">
                <div class="card-header">
                  <h5 class="mb-0">Jadwal Bimbingan Mendatang</h5>
                </div>
                <div class="card-body" id="jadwal-list">
                  <!-- dynamic content -->
                </div>
              </div>
            </div>
          </div>

          <!-- Data Mahasiswa (preview table) -->
          <div class="row mt-4">
            <div class="col-12">
              <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                  <h5 class="mb-0">Data Mahasiswa</h5>
                  <button class="btn btn-sm btn-primary" id="btn-add-mahasiswa"><i class="fas fa-plus me-1"></i> Tambah Data</button>
                </div>
                <div class="card-body">
                  <div class="table-responsive">
                    <table class="table table-bordered table-hover" id="table-mahasiswa">
                      <thead>
                        <tr><th>NIM</th><th>Nama</th><th>Umur</th><th>Jenis Kelamin</th><th>Telepon</th><th>Email</th><th>Aksi</th></tr>
                      </thead>
                      <tbody><!-- rows by JS --></tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div><!-- end dashboard -->

        <!-- Booking -->
        <div id="booking" class="content-section">
          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="mb-0">Booking Bimbingan</h5>
              <button class="btn btn-sm btn-primary" id="btn-booking-add"><i class="fas fa-plus me-1"></i> Buat Booking</button>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-bordered" id="table-booking">
                  <thead><tr><th>Tgl</th><th>Jam</th><th>Judul</th><th>Dosen</th><th>Status</th><th>Aksi</th></tr></thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Laporan -->
        <div id="laporan" class="content-section">
          <div class="card">
            <div class="card-header"><h5 class="mb-0">Laporan Bimbingan</h5></div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-bordered" id="table-laporan">
                  <thead><tr><th>Tgl</th><th>Judul</th><th>Isi Laporan</th><th>Dosen</th></tr></thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Mahasiswa page -->
        <div id="mahasiswa-section" class="content-section">
          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="mb-0">Data Mahasiswa</h5>
              <button class="btn btn-sm btn-primary" id="btn-add-mahasiswa-2"><i class="fas fa-plus me-1"></i> Tambah Data</button>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-bordered table-hover" id="table-mahasiswa-page">
                  <thead><tr><th>NIM</th><th>Nama</th><th>Umur</th><th>Jenis Kelamin</th><th>Telepon</th><th>Email</th><th>Aksi</th></tr></thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Dosen page -->
        <div id="dosen-section" class="content-section">
          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="mb-0">Data Dosen</h5>
              <button class="btn btn-sm btn-primary" id="btn-add-dosen"><i class="fas fa-plus me-1"></i> Tambah Dosen</button>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-bordered" id="table-dosen">
                  <thead><tr><th>ID</th><th>Nama</th><th>Prodi</th><th>Email</th><th>Aksi</th></tr></thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Riwayat -->
        <div id="riwayat" class="content-section">
          <div class="card">
            <div class="card-header"><h5 class="mb-0">Riwayat Bimbingan</h5></div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-bordered" id="table-riwayat">
                  <thead><tr><th>Tgl</th><th>Judul</th><th>Dosen</th><th>Keterangan</th></tr></thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Pengaturan -->
        <div id="pengaturan" class="content-section">
          <div class="card">
            <div class="card-header"><h5 class="mb-0">Pengaturan Akun</h5></div>
            <div class="card-body">
              <form id="form-settings">
                <div class="mb-3"><label class="form-label">Username</label><input id="setting-username" class="form-control" required></div>
                <div class="mb-3"><label class="form-label">Email</label><input id="setting-email" type="email" class="form-control" required></div>
                <div class="mb-3"><label class="form-label">Password (kosongkan bila tidak ganti)</label><input id="setting-password" type="password" class="form-control"></div>
                <button class="btn btn-primary" type="submit">Simpan</button>
                <button class="btn btn-danger ms-2" id="btn-logout-settings" type="button">Logout</button>
              </form>
            </div>
          </div>
        </div>

        <!-- Profil -->
        <div id="profil" class="content-section">
          <div class="card">
            <div class="card-header"><h5 class="mb-0">Profil</h5></div>
            <div class="card-body" id="profile-body"></div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- MODALS -->
  <!-- Mahasiswa Modal -->
  <div class="modal fade" id="modalMahasiswa" tabindex="-1">
    <div class="modal-dialog"><div class="modal-content">
      <div class="modal-header bg-primary text-white"><h5 class="modal-title">Tambah/Edit Mahasiswa</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <form id="formMahasiswa">
          <input type="hidden" id="m-index">
          <div class="mb-2"><input class="form-control" id="m-nim" placeholder="NIM" required></div>
          <div class="mb-2"><input class="form-control" id="m-nama" placeholder="Nama" required></div>
          <div class="mb-2"><input class="form-control" id="m-umur" placeholder="Umur" type="number" required></div>
          <div class="mb-2"><select class="form-select" id="m-jk" required><option value="">Pilih Jenis Kelamin</option><option value="Laki-laki">Laki-laki</option><option value="Perempuan">Perempuan</option></select></div>
          <div class="mb-2"><input class="form-control" id="m-telepon" placeholder="Telepon" required></div>
          <div class="mb-2"><input class="form-control" id="m-email" placeholder="Email" type="email" required></div>
          <div class="d-grid"><button class="btn btn-success" type="submit">Simpan</button></div>
        </form>
      </div>
    </div></div>
  </div>

  <!-- Booking Modal -->
  <div class="modal fade" id="modalBooking" tabindex="-1">
    <div class="modal-dialog"><div class="modal-content">
      <div class="modal-header bg-primary text-white"><h5 class="modal-title">Buat Booking Bimbingan</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <form id="formBooking">
          <div class="mb-2"><input class="form-control" id="b-tgl" type="date" required></div>
          <div class="mb-2"><input class="form-control" id="b-jam" type="time" required></div>
          <div class="mb-2"><input class="form-control" id="b-judul" placeholder="Judul / Topik" required></div>
          <div class="mb-2"><select class="form-select" id="b-dosen" required></select></div>
          <div class="mb-2"><textarea class="form-control" id="b-keterangan" placeholder="Keterangan (opsional)"></textarea></div>
          <div class="d-grid"><button class="btn btn-success" type="submit">Booking</button></div>
        </form>
      </div>
    </div></div>
  </div>

  <!-- Detail Mahasiswa Modal -->
  <div class="modal fade" id="modalDetailMahasiswa" tabindex="-1">
    <div class="modal-dialog"><div class="modal-content">
      <div class="modal-header bg-info text-white"><h5 class="modal-title">Detail Mahasiswa</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body" id="detailMahasiswaBody"></div>
    </div></div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    /************ KEYS & HELPERS ************/
    const KEY_USERS = 'bk_users';
    const KEY_CURRENT = 'bk_current';
    const KEY_STUDENTS = 'bk_students';
    const KEY_DOSEN = 'bk_dosen';
    const KEY_BOOKINGS = 'bk_bookings';
    const KEY_LAPORAN = 'bk_laporan';

    function loadFromStorage(key, def){
      try { const v = localStorage.getItem(key); return v ? JSON.parse(v) : def; } catch(e){ return def; }
    }
    function saveToStorage(key, val){
      localStorage.setItem(key, JSON.stringify(val));
    }

    // Always load fresh arrays from storage when performing writes to reduce overwrite risk
    function freshUsers(){ return loadFromStorage(KEY_USERS, []); }
    function freshStudents(){ return loadFromStorage(KEY_STUDENTS, []); }
    function freshDosen(){ return loadFromStorage(KEY_DOSEN, []); }
    function freshBookings(){ return loadFromStorage(KEY_BOOKINGS, []); }
    function freshLaporan(){ return loadFromStorage(KEY_LAPORAN, []); }

    /************ INITIAL STATE (load once) ************/
    let users = loadFromStorage(KEY_USERS, []);
    let currentUser = loadFromStorage(KEY_CURRENT, null);
    let students = loadFromStorage(KEY_STUDENTS, []);
    let dosen = loadFromStorage(KEY_DOSEN, []);
    let bookings = loadFromStorage(KEY_BOOKINGS, []);
    let laporan = loadFromStorage(KEY_LAPORAN, []);

    // DOM refs
    const registerPage = document.getElementById('register-page');
    const loginPage = document.getElementById('login-page');
    const mainApp = document.getElementById('main-app');

    if(currentUser){
      showMain();
    } else {
      registerPage.style.display = 'none';
      loginPage.style.display = 'flex';
    }

    /************ NAV / UI helpers ************/
    function showSectionById(id){
      document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
      const el = document.getElementById(id);
      if(el) el.classList.add('active');
      document.querySelectorAll('.sidebar a').forEach(a => a.classList.remove('active'));
      const link = document.querySelector(`.sidebar a[data-target="${id}"]`);
      if(link) link.classList.add('active');
      if(id === 'pengaturan') fillSettingsForm();
      if(id === 'profil') renderProfile();
      if(id === 'mahasiswa-section') renderStudentsTable('#table-mahasiswa-page tbody');
      if(id === 'booking') renderBookingTable();
    }

    document.querySelectorAll('.sidebar a').forEach(a=>{
      a.addEventListener('click', function(e){
        e.preventDefault();
        const target = this.dataset.target;
        if(target) showSectionById(target);
      });
    });

    document.getElementById('menu-profil').addEventListener('click', e => { e.preventDefault(); showSectionById('profil'); });
    document.getElementById('menu-settings').addEventListener('click', e => { e.preventDefault(); showSectionById('pengaturan'); });

    document.getElementById('to-register').addEventListener('click', e=>{ e.preventDefault(); loginPage.style.display='none'; registerPage.style.display='flex'; });
    document.getElementById('to-login-from-reg').addEventListener('click', e=>{ e.preventDefault(); registerPage.style.display='none'; loginPage.style.display='flex'; });

    /************ AUTH - Register & Login ************/
    document.getElementById('register-form').addEventListener('submit', function(e){
      e.preventDefault();
      const username = document.getElementById('reg-username').value.trim();
      const email = document.getElementById('reg-email').value.trim();
      const password = document.getElementById('reg-password').value;
      const role = document.getElementById('reg-role').value;
      if(!username || !email || !password){ alert('Lengkapi data!'); return; }

      // load fresh users to avoid stale array
      users = freshUsers();
      if(users.some(u => u.username === username || u.email === email)){ alert('Username atau email sudah terdaftar'); return; }
      const newUser = {username, email, password, role};
      users.push(newUser); saveToStorage(KEY_USERS, users);

      alert('Akun berhasil didaftarkan. Silakan login.');
      this.reset();
      registerPage.style.display = 'none';
      loginPage.style.display = 'flex';
    });

    document.getElementById('login-form').addEventListener('submit', function(e){
      e.preventDefault();
      const iden = document.getElementById('username').value.trim();
      const pw = document.getElementById('password').value;
      users = freshUsers();
      const u = users.find(x => (x.username === iden || x.email === iden) && x.password === pw);
      if(!u){ alert('Username/email atau password salah. Pastikan sudah daftar.'); return; }
      currentUser = u; saveToStorage(KEY_CURRENT, currentUser);
      // reload other datasets fresh to ensure we display latest
      students = freshStudents(); dosen = freshDosen(); bookings = freshBookings(); laporan = freshLaporan();
      showMain();
    });

    document.getElementById('logout-btn').addEventListener('click', function(e){
      e.preventDefault(); logout();
    });
    document.getElementById('btn-logout-settings').addEventListener('click', logout);

    function logout(){
      currentUser = null; localStorage.removeItem(KEY_CURRENT);
      mainApp.style.display = 'none';
      loginPage.style.display = 'flex';
      document.getElementById('login-form').reset();
    }

    function showMain(){
      loginPage.style.display = 'none';
      registerPage.style.display = 'none';
      mainApp.style.display = 'block';
      document.getElementById('user-name').textContent = currentUser ? `${currentUser.username} (${currentUser.role})` : 'Nama Pengguna';
      renderCounts();
      renderStudentsTable('#table-mahasiswa tbody');
      renderStudentsTable('#table-mahasiswa-page tbody');
      renderDosenTable();
      renderBookingTable();
      renderLaporanTable();
      renderRiwayatTable();
      renderJadwalDashboard();
      fillBookingDosenOptions();

      // role-based controls
      document.getElementById('btn-add-mahasiswa').style.display = 'none';
      document.getElementById('btn-add-mahasiswa-2').style.display = 'none';
      document.getElementById('btn-add-dosen').style.display = 'none';
      document.getElementById('btn-booking-add').style.display = 'none';
      if(currentUser.role === 'mahasiswa'){
        document.getElementById('btn-booking-add').style.display = 'inline-block';
      } else if(currentUser.role === 'dosen'){
        document.getElementById('btn-add-mahasiswa').style.display = 'inline-block';
        document.getElementById('btn-add-mahasiswa-2').style.display = 'inline-block';
        document.getElementById('btn-add-dosen').style.display = 'inline-block';
      }
      showSectionById('dashboard');
    }

    /************ Students CRUD ************/
    const modalMahasiswa = new bootstrap.Modal(document.getElementById('modalMahasiswa'));
    document.getElementById('btn-add-mahasiswa').addEventListener('click', ()=> openMahasiswaModal());
    document.getElementById('btn-add-mahasiswa-2').addEventListener('click', ()=> openMahasiswaModal());
    function openMahasiswaModal(data=null, idx=null){
      document.getElementById('formMahasiswa').reset();
      if(data){
        document.getElementById('m-index').value = idx;
        document.getElementById('m-nim').value = data.nim;
        document.getElementById('m-nama').value = data.nama;
        document.getElementById('m-umur').value = data.umur;
        document.getElementById('m-jk').value = data.jk;
        document.getElementById('m-telepon').value = data.tel;
        document.getElementById('m-email').value = data.email;
      } else {
        document.getElementById('m-index').value = '';
      }
      modalMahasiswa.show();
    }

    document.getElementById('formMahasiswa').addEventListener('submit', function(e){
      e.preventDefault();
      // only dosen allowed to create/edit students
      if(!currentUser || currentUser.role !== 'dosen'){
        alert('Hanya dosen yang dapat menambah/mengubah data mahasiswa.'); modalMahasiswa.hide(); return;
      }
      const idx = document.getElementById('m-index').value;
      // load fresh students
      students = freshStudents();
      const obj = {
        nim: document.getElementById('m-nim').value.trim(),
        nama: document.getElementById('m-nama').value.trim(),
        umur: Number(document.getElementById('m-umur').value),
        jk: document.getElementById('m-jk').value,
        tel: document.getElementById('m-telepon').value.trim(),
        email: document.getElementById('m-email').value.trim()
      };
      if(idx === ''){
        students.push(obj);
      } else {
        students[Number(idx)] = obj;
      }
      saveToStorage(KEY_STUDENTS, students);
      modalMahasiswa.hide();
      renderStudentsTable('#table-mahasiswa tbody');
      renderStudentsTable('#table-mahasiswa-page tbody');
      renderCounts();
    });

    function renderStudentsTable(selector){
      const tbody = document.querySelector(selector);
      if(!tbody) return;
      students = freshStudents();
      tbody.innerHTML = '';
      students.forEach((s,i)=>{
        const tr = document.createElement('tr');
        let aksi = `<button class="btn btn-info btn-sm me-1" onclick="lihatMahasiswa(${i})"><i class="fas fa-eye"></i></button>`;
        if(currentUser && currentUser.role === 'dosen'){
          aksi += `<button class="btn btn-warning btn-sm me-1" onclick="editMahasiswa(${i})"><i class="fas fa-edit"></i></button>
                  <button class="btn btn-danger btn-sm" onclick="hapusMahasiswa(${i})"><i class="fas fa-trash"></i></button>`;
        }
        tr.innerHTML = `<td>${s.nim}</td><td>${s.nama}</td><td>${s.umur}</td><td>${s.jk}</td><td>${s.tel}</td><td>${s.email}</td><td>${aksi}</td>`;
        tbody.appendChild(tr);
      });
    }

    window.lihatMahasiswa = function(i){
      students = freshStudents();
      const s = students[i];
      const body = document.getElementById('detailMahasiswaBody');
      body.innerHTML = `<p><b>NIM:</b> ${s.nim}</p><p><b>Nama:</b> ${s.nama}</p><p><b>Umur:</b> ${s.umur}</p><p><b>Jenis Kelamin:</b> ${s.jk}</p><p><b>Telepon:</b> ${s.tel}</p><p><b>Email:</b> ${s.email}</p>`;
      new bootstrap.Modal(document.getElementById('modalDetailMahasiswa')).show();
    };

    window.editMahasiswa = function(i){
      if(!currentUser || currentUser.role !== 'dosen'){ alert('Tidak punya akses'); return; }
      students = freshStudents();
      openMahasiswaModal(students[i], i);
    };

    window.hapusMahasiswa = function(i){
      if(!currentUser || currentUser.role !== 'dosen'){ alert('Tidak punya akses'); return; }
      if(!confirm('Yakin ingin menghapus data mahasiswa ini?')) return;
      students = freshStudents();
      students.splice(i,1); saveToStorage(KEY_STUDENTS, students);
      renderStudentsTable('#table-mahasiswa tbody'); renderStudentsTable('#table-mahasiswa-page tbody'); renderCounts();
    };

    /************ Dosen CRUD ************/
    document.getElementById('btn-add-dosen').addEventListener('click', function(){
      if(!currentUser || currentUser.role !== 'dosen'){ alert('Tidak punya akses'); return; }
      dosen = freshDosen();
      const nama = prompt('Nama Dosen:'); if(!nama) return;
      const prodi = prompt('Prodi:') || '';
      const email = prompt('Email:') || '';
      const id = 'D' + String(Math.floor(Math.random()*900+100));
      dosen.push({id, nama, prodi, email});
      saveToStorage(KEY_DOSEN, dosen);
      renderDosenTable(); renderCounts(); fillBookingDosenOptions(); renderJadwalDashboard();
    });

    function renderDosenTable(){
      dosen = freshDosen();
      const tbody = document.querySelector('#table-dosen tbody'); if(!tbody) return;
      tbody.innerHTML = '';
      dosen.forEach((d,i)=>{
        const tr = document.createElement('tr');
        let aksi = `<button class="btn btn-info btn-sm me-1" onclick="alert('Detail: ${d.nama}\\n${d.prodi}\\n${d.email}')"><i class="fas fa-eye"></i></button>`;
        if(currentUser && currentUser.role === 'dosen'){
          aksi += `<button class="btn btn-warning btn-sm me-1" onclick="editDosen(${i})"><i class="fas fa-edit"></i></button>
                  <button class="btn btn-danger btn-sm" onclick="hapusDosen(${i})"><i class="fas fa-trash"></i></button>`;
        }
        tr.innerHTML = `<td>${d.id}</td><td>${d.nama}</td><td>${d.prodi}</td><td>${d.email}</td><td>${aksi}</td>`;
        tbody.appendChild(tr);
      });
      document.getElementById('count-dosen').innerText = dosen.length;
    }

    window.editDosen = function(i){
      if(!currentUser || currentUser.role !== 'dosen'){ alert('Tidak punya akses'); return; }
      dosen = freshDosen();
      const d = dosen[i];
      const nama = prompt('Nama Dosen:', d.nama); if(!nama) return;
      const prodi = prompt('Prodi:', d.prodi) || '';
      const email = prompt('Email:', d.email) || '';
      dosen[i] = { ...d, nama, prodi, email };
      saveToStorage(KEY_DOSEN, dosen); renderDosenTable(); fillBookingDosenOptions(); renderJadwalDashboard();
    };

    window.hapusDosen = function(i){
      if(!currentUser || currentUser.role !== 'dosen'){ alert('Tidak punya akses'); return; }
      if(!confirm('Hapus dosen?')) return;
      dosen = freshDosen(); dosen.splice(i,1); saveToStorage(KEY_DOSEN, dosen);
      renderDosenTable(); fillBookingDosenOptions(); renderJadwalDashboard();
    };

    /************ Booking ************/
    const modalBooking = new bootstrap.Modal(document.getElementById('modalBooking'));
    document.getElementById('btn-booking-add').addEventListener('click', ()=> {
      if(!currentUser){ alert('Login dahulu'); return; }
      if(currentUser.role !== 'mahasiswa'){ alert('Hanya mahasiswa yang dapat membuat booking.'); return; }
      document.getElementById('formBooking').reset(); fillBookingDosenOptions(); modalBooking.show();
    });

    function fillBookingDosenOptions(){
      dosen = freshDosen();
      const sel = document.getElementById('b-dosen');
      sel.innerHTML = '';
      dosen.forEach(d => {
        const o = document.createElement('option'); o.value = d.nama; o.textContent = `${d.nama} (${d.prodi})`; sel.appendChild(o);
      });
      if(dosen.length===0){ const o=document.createElement('option'); o.value=''; o.textContent='-- Belum ada dosen --'; sel.appendChild(o); }
    }

    document.getElementById('formBooking').addEventListener('submit', function(e){
      e.preventDefault();
      if(!currentUser || currentUser.role !== 'mahasiswa'){ alert('Hanya mahasiswa yang dapat membuat booking.'); return; }
      bookings = freshBookings();
      const tgl = document.getElementById('b-tgl').value;
      const jam = document.getElementById('b-jam').value;
      const judul = document.getElementById('b-judul').value.trim();
      const dosenNama = document.getElementById('b-dosen').value;
      const ket = document.getElementById('b-keterangan').value.trim();
      bookings.push({tgl, jam, judul, dosen: dosenNama, ket, status:'Menunggu', owner: currentUser.username, id: Date.now()});
      saveToStorage(KEY_BOOKINGS, bookings);
      modalBooking.hide();
      renderBookingTable(); renderJadwalDashboard();
    });

    function renderBookingTable(){
      bookings = freshBookings();
      const tbody = document.querySelector('#table-booking tbody'); tbody.innerHTML = '';
      bookings.forEach((b,i)=>{
        const canApprove = currentUser && currentUser.role === 'dosen';
        const isOwner = currentUser && currentUser.username === b.owner;
        let aksi = '';
        if(canApprove){
          if(b.status === 'Menunggu'){
            aksi += `<button class="btn btn-success btn-sm me-1" onclick="approveBooking(${i})" title="Setujui"><i class="fas fa-check-double"></i></button>`;
            aksi += `<button class="btn btn-warning btn-sm me-1" onclick="rejectBooking(${i})" title="Tolak"><i class="fas fa-ban"></i></button>`;
          } else if(b.status === 'Disetujui'){
            aksi += `<button class="btn btn-primary btn-sm me-1" onclick="confirmCompleteBooking(${i})" title="Selesai"><i class="fas fa-clipboard-check"></i></button>`;
            aksi += `<button class="btn btn-warning btn-sm me-1" onclick="rejectBooking(${i})" title="Tolak & Simpan Riwayat"><i class="fas fa-ban"></i></button>`;
          }
          aksi += `<button class="btn btn-danger btn-sm" onclick="hapusBooking(${i})" title="Hapus"><i class="fas fa-trash"></i></button>`;
        } else {
          if(isOwner){
            aksi += `<button class="btn btn-danger btn-sm" onclick="hapusBooking(${i})" title="Batalkan"><i class="fas fa-times"></i></button>`;
          } else {
            aksi += `<span class="text-muted">-</span>`;
          }
        }
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${b.tgl}</td><td>${b.jam}</td><td>${b.judul}</td><td>${b.dosen}</td><td>${b.status}</td><td>${aksi}</td>`;
        tbody.appendChild(tr);
      });
    }

    window.approveBooking = function(i){
      if(!currentUser || currentUser.role !== 'dosen'){ alert('Tidak punya akses'); return; }
      if(!confirm('Setujui booking ini?')) return;
      bookings = freshBookings(); bookings[i].status = 'Disetujui'; saveToStorage(KEY_BOOKINGS, bookings);
      renderBookingTable(); renderJadwalDashboard();
    };

    window.rejectBooking = function(i){
      if(!currentUser || currentUser.role !== 'dosen'){ alert('Tidak punya akses'); return; }
      const reason = prompt('Masukkan alasan penolakan (opsional):', '');
      bookings = freshBookings();
      const b = bookings[i];
      const keterangan = `Ditolak${reason ? ' — ' + reason : ''}`;
      laporan = freshLaporan(); laporan.push({tgl: b.tgl, judul: b.judul, dosen: b.dosen, isi: keterangan, id: Date.now()});
      bookings.splice(i,1);
      saveToStorage(KEY_LAPORAN, laporan); saveToStorage(KEY_BOOKINGS, bookings);
      renderBookingTable(); renderLaporanTable(); renderRiwayatTable(); renderJadwalDashboard();
    };

    window.confirmCompleteBooking = function(i){
      if(!currentUser || currentUser.role !== 'dosen'){ alert('Tidak punya akses'); return; }
      if(!confirm('Tandai booking ini selesai dan simpan ke riwayat?')) return;
      bookings = freshBookings();
      const b = bookings[i];
      const hasil = prompt("Masukkan ringkasan hasil bimbingan (akan disimpan di laporan):", b.ket || "-");
      laporan = freshLaporan(); laporan.push({tgl:b.tgl, judul:b.judul, dosen:b.dosen, isi:hasil || '-', id:Date.now()});
      bookings.splice(i,1);
      saveToStorage(KEY_LAPORAN, laporan); saveToStorage(KEY_BOOKINGS, bookings);
      renderBookingTable(); renderLaporanTable(); renderRiwayatTable(); renderJadwalDashboard();
    };

    window.hapusBooking = function(i){
      if(!currentUser){ alert('Tidak punya akses'); return; }
      bookings = freshBookings();
      if(currentUser.role === 'mahasiswa' && bookings[i].owner !== currentUser.username){ alert('Tidak boleh menghapus booking orang lain'); return; }
      if(!confirm('Hapus booking ini?')) return;
      bookings.splice(i,1); saveToStorage(KEY_BOOKINGS, bookings);
      renderBookingTable(); renderJadwalDashboard();
    };

    /************ Laporan & Riwayat ************/
    function renderLaporanTable(){
      laporan = freshLaporan();
      const tbody = document.querySelector('#table-laporan tbody'); tbody.innerHTML = '';
      laporan.forEach(l=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${l.tgl || '-'}</td><td>${l.judul}</td><td>${l.isi}</td><td>${l.dosen || '-'}</td>`;
        tbody.appendChild(tr);
      });
    }

    function renderRiwayatTable(){
      laporan = freshLaporan();
      const tbody = document.querySelector('#table-riwayat tbody'); tbody.innerHTML = '';
      laporan.forEach(l=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${l.tgl || '-'}</td><td>${l.judul}</td><td>${l.dosen || '-'}</td><td>${l.isi}</td>`;
        tbody.appendChild(tr);
      });
    }

    /************ Jadwal Dashboard (role aware) ************/
    function renderJadwalDashboard(){
      bookings = freshBookings();
      const container = document.getElementById('jadwal-list');
      container.innerHTML = '';
      const approved = bookings
        .filter(b => b.status === 'Disetujui')
        .map(b => ({...b, __date: new Date(b.tgl + 'T' + (b.jam || '00:00'))}))
        .filter(b => !isNaN(b.__date))
        .sort((a,b)=> a.__date - b.__date);

      let shown = approved;
      if(currentUser && currentUser.role === 'mahasiswa'){
        shown = approved.filter(b => b.owner === currentUser.username);
      }
      if(shown.length === 0){
        container.innerHTML = `<p class="text-muted">Belum ada jadwal bimbingan yang disetujui.</p>`; return;
      }
      shown.forEach(b=>{
        const date = b.__date;
        const day = date.getDate();
        const month = date.toLocaleString('id-ID', { month:'short' });
        container.innerHTML += `
          <div class="d-flex align-items-center border-bottom pb-3 mb-3">
            <div class="bg-primary text-white rounded p-2 me-3"><h6 class="mb-0">${day}</h6><small>${month}</small></div>
            <div><h6 class="mb-0">${b.judul}</h6><small>${b.jam} WIB — ${b.dosen}</small></div>
          </div>`;
      });
    }

    /************ Settings & Profile ************/
    function fillSettingsForm(){
      if(!currentUser) return;
      document.getElementById('setting-username').value = currentUser.username || '';
      document.getElementById('setting-email').value = currentUser.email || '';
      document.getElementById('setting-password').value = '';
    }

    document.getElementById('form-settings').addEventListener('submit', function(e){
      e.preventDefault();
      if(!currentUser){ alert('Tidak ada user aktif'); return; }
      const newUser = document.getElementById('setting-username').value.trim();
      const newEmail = document.getElementById('setting-email').value.trim();
      const newPass = document.getElementById('setting-password').value;
      users = freshUsers();
      // conflicts check
      if(newUser !== currentUser.username && users.some(u=>u.username===newUser)){ alert('Username sudah digunakan'); return; }
      if(newEmail !== currentUser.email && users.some(u=>u.email===newEmail)){ alert('Email sudah digunakan'); return; }
      users = users.map(u => {
        if(u.username === currentUser.username && u.email === currentUser.email){
          return { ...u, username: newUser, email: newEmail, password: newPass ? newPass : u.password, role: u.role };
        }
        return u;
      });
      saveToStorage(KEY_USERS, users);
      currentUser.username = newUser; currentUser.email = newEmail;
      if(newPass) currentUser.password = newPass;
      saveToStorage(KEY_CURRENT, currentUser);
      document.getElementById('user-name').textContent = `${currentUser.username} (${currentUser.role})`;
      alert('Pengaturan disimpan');
      document.getElementById('setting-password').value = '';
      renderBookingTable(); renderJadwalDashboard();
    });

    function renderProfile(){
      const body = document.getElementById('profile-body');
      if(!currentUser){ body.innerHTML = '<p>Tidak ada user</p>'; return; }
      body.innerHTML = `<p><b>Username:</b> ${currentUser.username}</p><p><b>Email:</b> ${currentUser.email}</p><p><b>Role:</b> ${currentUser.role}</p>`;
    }

    /************ Misc: counters ************/
    function renderCounts(){
      students = freshStudents(); dosen = freshDosen();
      document.getElementById('count-mahasiswa').innerText = students.length;
      document.getElementById('count-dosen').innerText = dosen.length;
    }

    /************ Initial render ************/
    renderCounts();
    renderStudentsTable('#table-mahasiswa tbody');
    renderStudentsTable('#table-mahasiswa-page tbody');
    renderDosenTable();
    renderBookingTable();
    renderLaporanTable();
    renderRiwayatTable();
    renderJadwalDashboard();
    fillBookingDosenOptions();

    // expose for inline onclick uses
    window.renderBookingTable = renderBookingTable;
    window.renderLaporanTable = renderLaporanTable;
    window.renderRiwayatTable = renderRiwayatTable;
    window.renderJadwalDashboard = renderJadwalDashboard;
    window.lihatMahasiswa = window.lihatMahasiswa;
    window.editMahasiswa = window.editMahasiswa;
    window.hapusMahasiswa = window.hapusMahasiswa;
    window.editDosen = window.editDosen;
    window.hapusDosen = window.hapusDosen;
    window.approveBooking = window.approveBooking;
    window.rejectBooking = window.rejectBooking;
    window.confirmCompleteBooking = window.confirmCompleteBooking;
    window.hapusBooking = window.hapusBooking;
  </script>
</body>
</html>
